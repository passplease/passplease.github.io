---
title: ä¸ºUbuntuä¸»æœºé…ç½®Privado VPN
author: me
date: 2026-02-06 8:25:00 +0800
description: å¦‚ä½•ä¸ºUbuntuç³»ç»Ÿçš„ç”µè„‘é…ç½®Privado VPNï¼Œå¹¶ä¸”æ”¯æŒåŸŸåç™½åå•è®¿é—®
categories:
  - è®¡ç®—æœº
  - ç½‘ç»œ
tags:
  - è®¡ç®—æœº
  - æ¢¯å­
---
> æœ¬æ–‡æ˜¯å’ŒChatGPTã€Geminiå¯¹è¯åæ“ä½œçš„æ€»ç»“ï¼Œæˆ‘ä¹Ÿä¸ä¸€å®šå®Œå…¨æ‡‚å…¨éƒ¨é…ç½®ï¼Œæˆ‘ä¹Ÿæ‰¾åˆ°ä¸€ç¯‡[æ•™ç¨‹](https://blog.jove.im/post/2025/02/wireguard-route-by-ipset/)ï¼Œå„ä½ä¹Ÿå¯ä»¥å»çœ‹

## èµ·å› å’ŒåŸºç¡€ä¿¡æ¯
èµ·åˆéœ€è¦æ˜¯å› ä¸ºN8Nä¸­æŠŠæ¯æ—¥æ–°é—»æ¨é€åˆ°Githubï¼Œè¿›è€ŒNetlifyæ—¶ï¼Œå›½å†…ä¸èƒ½ç¨³å®šè¿æ¥Githubï¼Œäºæ˜¯æˆ‘å°±ç´¢æ€§æŠŠPrivado VPNä¹Ÿé…ç½®ä¸Šï¼Œæœ‰æ¢¯å­å°±è‚¯å®šä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚å¯æ˜¯é…ç½®å¥½ä¹‹åï¼ŒN8Nä¸­è·å–å›½å†…æ–°é—»çš„RSSè®¢é˜…å°±ç”¨ä¸äº†äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºé“¾æ¥åœ¨å›½å†…ï¼Œæ‰€ä»¥åˆå»é…ç½®åŸŸåç™½åå•ã€‚<br><br>
æˆ‘çš„éœ€æ±‚æœ‰è¿™äº›ï¼š
- æ¢¯å­èƒ½ç”¨ï¼Œä¸”å¯ä»¥ç™½åå•è®¿é—®
- [ZeroTier](../ä½¿ç”¨ZeroTier/)ä¸å½±å“ä½¿ç”¨
- IPV6ä¸å½±å“è®¿é—®ï¼ˆæˆ‘éœ€è¦IPV6å…¬ç½‘ï¼‰

ç”µè„‘åŸºç¡€ä¿¡æ¯ï¼š
-No LSB modules are available.
- Distributor ID: Ubuntu
- Description:    Ubuntu 24.04.3 LTS
- Release:        24.04
- Codename:       noble

## åŠ è£…Privado VPN
è¿™é‡Œæ€»å…±æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘åœ¨1æœˆå…ˆä½¿ç”¨çš„OpenVPNæ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸè¿æ¥åç¬¬äºŒæ¬¡å°±ä¸€å®šä¼šå¤±è´¥ï¼Œæˆ‘åˆ†ææ˜¯è¢«â€œå¢™â€æ‹¦æˆªäº†ï¼Œæ‰€ä»¥æ›´æ¨èä½¿ç”¨WireGuardæ–¹æ³•ï¼Œä¸å®¹æ˜“è¢«â€œå¢™â€æ‹¦æˆªã€‚é¦–å…ˆè´´å‡ºå®˜æ–¹é…ç½®æ•™ç¨‹[^official]ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯å‘½ä»¤è¡Œç¯å¢ƒï¼Œå› ä¸ºæ˜¯SSHè¿æ¥åˆ°ç”µè„‘çš„ã€‚<br><br>
é¦–å…ˆéœ€è¦å»è‡ªå·±è´¦å·çš„[ç®¡ç†é¡µé¢](https://app.privadovpn.com/en/admin-panel)è·å–WireGuradçš„é…ç½®æ–‡ä»¶ï¼ˆå¾€ä¸‹åˆ’å°±çœ‹åˆ°äº†ï¼‰ï¼Œç„¶åè½¬ç§»åˆ°Ubuntuä¸»æœºä¸Šï¼ˆä¸‹é¢å‡è®¾è½¬ç§»åˆ°çš„è·¯å¾„æ˜¯`/wiregurad_config/<config_name>`{: .filepath} ã€‚è‡³äºè¿™é‡Œçš„`<config_name>`èƒ½ä¸èƒ½æ”¹ï¼Œæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæˆ‘æ€€ç–‘å®ƒçš„åå­—æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰æ›´æ”¹ã€‚<br><br>
ç„¶åæ˜¯å®‰è£…WireGuardï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤
```bash
sudo apt update && sudo apt install wireguard
```
éšåå°†å‰é¢è·å–çš„é…ç½®æ–‡ä»¶ç§»åŠ¨åˆ°WireGuardçš„é…ç½®æ–‡ä»¶å¤¹ä¸‹ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè¿™ä¸ªå‘½ä»¤
```bash
sudo mv /wireguard_config/<config_name> /etc/wireguard/<config_name>
```


æ¥ä¸‹æ¥å¯ä»¥è¯•è¯•é…ç½®æ–‡ä»¶èƒ½ä¸èƒ½æ­£å¸¸åŠ è½½äº†ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œå‰é¢çš„`<config_name>`æ˜¯å¸¦æœ‰`.conf`åç¼€çš„ï¼Œè€Œä¸‹é¢çš„è¿™ä¸ªä¸éœ€è¦åç¼€åï¼Œä¹Ÿå°±æ˜¯ä¸å¸¦`.conf`
```bash
sudo wg-quick up <config_name> # å…³é—­æŠŠupæ”¹down
```
è§åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºå°±æ˜¯æ²¡é—®é¢˜çš„
```
[#] wg setconf privado.ams-034 /dev/fd/63
[#] ip -4 address add 100.65.38.223/32 dev privado.ams-034
[#] ip link set mtu 1420 up dev privado.ams-034
[#] wg set privado.ams-034 fwmark 51820
[#] ip -4 rule add not fwmark 51820 table 51820
[#] ip -4 rule add table main suppress_prefixlength 0
[#] ip -4 route add 0.0.0.0/0 dev privado.ams-034 table 51820
[#] sysctl -q net.ipv4.conf.all.src_valid_mark=1
[#] nft -f /dev/fd/63
```


ç„¶åæˆ‘ä»¬å°±å¯ä»¥é…ç½®å®ƒå¼€æœºè‡ªå¯åŠ¨äº†ï¼Œè¿™ä¸ªä¹Ÿå¾ˆç®€å•ï¼ŒWireGuardè‡ªå¸¦Servicesï¼Œç›´æ¥å¼€å¯å¯¹åº”Serviceså°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹ï¼Œæ³¨æ„è¿™é‡Œ`<config_name>`ä¹Ÿä¸å¸¦`.conf`
```bash
sudo systemctl enable wg-quick@<config_name>.service
```


è¿™æ ·å®ƒå°±ä¼šå¼€æœºè‡ªå¯åŠ¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬çš„å¤–éƒ¨åœ°å€ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤
```bash
curl ipinfo.io
```
æ¯”å¦‚æˆ‘è¿æ¥çš„æ˜¯é˜¿å§†æ–¯ç‰¹ä¸¹ï¼Œè¿”å›å°±å¦‚ä¸‹
```json
{
  "ip": "91.148.245.68",
  "city": "Heerhugowaard",
  "region": "North Holland",
  "country": "NL",
  "loc": "52.6714,4.8486",
  "org": "AS34343 BIP Backbone ASN",
  "postal": "1701",
  "timezone": "Europe/Amsterdam",
  "readme": "https://ipinfo.io/missingauth"
}
```
## é…ç½®ç™½åå•è®¿é—®
ç°åœ¨æˆ‘ä»¬å°±å®Œæˆäº†WireGuardçš„å®‰è£…ï¼Œä¸‹é¢å°±æ˜¯ä¸ºå…¶æ·»åŠ ä¸€ä¸ªç™½åå•è¿‡æ»¤ã€‚åŸç†ä¸Šï¼ŒWireGuardæ”¯æŒå¯¹é™æ€IPè¿›è¡Œé…ç½®ï¼Œä½†æ˜¯ä¸æ”¯æŒåŸŸåå’ŒåŠ¨æ€IPï¼Œå¯¹äºæˆ‘ä»¬çš„éœ€æ±‚æ¥è¯´ï¼Œè¿™å¾ˆæ˜¾ç„¶ä¸å¤Ÿï¼Œä½ ä¸å¯èƒ½æœŸæœ›`Google,ChatGPT,Github`è¿™äº›å¤§ç½‘ç«™éƒ½æ˜¯é™æ€IPï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡å–çš„æ–¹æ³•æ˜¯ï¼Œè‡ªå»ºDNSæœåŠ¡ç»´æŠ¤è¿™äº›ç½‘ç«™çš„IPï¼ŒWireGuardæ ¹æ®è¿™äº›IPæ§åˆ¶æ˜¯ä¸æ˜¯ç»è¿‡VPNã€‚æ‰€ä»¥è¿™é‡Œæœ€ä¸»è¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªæœ¬åœ°DNSæœåŠ¡æ¥ç»´æŠ¤è¿™äº›IPã€‚<br><br>
è¿™é‡ŒChatGPTç»™æˆ‘çš„å»ºè®®æ˜¯
> ğŸ¥‡ **smartdns + ipset + nftables + WireGuardï¼ˆç™½åå•æ¨¡å¼ï¼‰**

å…¶ä¸­**smartdns**æ˜¯æœ¬åœ°çš„DNSæœåŠ¡ï¼Œä¸è¿‡æœ€ç»ˆæˆ‘æ„Ÿè§‰**ipset**å¥½åƒæ²¡æœ‰ç”¨ã€‚ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥å®‰è£…å®ƒä»¬ï¼Œå¤§å®¶å¯ä»¥å…ˆä¸å®‰è£…**ipset**ï¼Œçœ‹çœ‹åé¢éœ€ä¸éœ€è¦å†è¯´ã€‚
```bash
sudo apt update
sudo apt install smartdns ipset nftables
```

ç„¶åæ˜¯ä¸ºPrivadoåˆ›å»ºä¸€ä¸ªIPè¡¨ï¼Œæœ€åˆChatGPTç»™çš„å‘½ä»¤æ˜¯
```bash
sudo ipset create vpnset hash:ip timeout 3600
```
ä½†æ˜¯æˆ‘ç”¨äº†ä¹‹ååé¢æŠ¥é”™ï¼Œ**nft**ä¸è¯†åˆ«`vpnset`è¿™ä¸ªç»„ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»º**nft**è‡ªå·±çš„ç»„å¹¶åšä¸€ä¸‹é…ç½®ï¼Œä¸è¿‡é…ç½®å‰æˆ‘ä»¬éœ€è¦çŸ¥é“Privadoå¯¹åº”çš„fwmarkå‚æ•°ï¼ˆè¿™ä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œæœ€å¥½æ˜¯å¯¹åº”ä¸Šï¼‰ï¼Œæ‰§è¡Œè¿™ä¸ªå‘½ä»¤æŸ¥è¯¢
```bash
sudo wg show
```
æˆ‘å¾—åˆ°çš„è¾“å‡ºæ˜¯è¿™æ ·çš„
```
interface: privado.ams-034
  public key: Ahï¼ˆä¸­é—´ç æ‰ï¼‰=
  private key: (hidden)
  listening port: 58794
  fwmark: 0xca6c # å°±æ˜¯è¿™ä¸ª

peer: Kgï¼ˆä¸­é—´ç æ‰ï¼‰=
  endpoint: ï¼ˆæˆ‘ç æ‰äº†ï¼‰
  allowed ips: 0.0.0.0/0
  latest handshake: 2 minutes, 20 seconds ago
  transfer: 98.25 KiB received, 133.30 KiB sent
```

è¦çš„å°±æ˜¯`fwmark`å‚æ•°ï¼Œç„¶åæˆ‘ä»¬è¿›è¡Œé…ç½®ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤[^nftcommand]
```bash
sudo nft add table inet vpn
sudo nft add set inet vpn vpnset '{ type ipv4_addr; flags interval,timeout; timeout 1h; }'

# ç»™éç™½åå•æ‰“æ ‡ï¼ˆèµ°ç›´è¿ï¼‰
sudo nft add chain inet vpn output '{ type route hook output priority mangle; policy accept; }'
sudo nft add rule inet vpn output ip daddr != @vpnset meta mark set 0xca6c counter

# ä¿è¯è½¬å‘æµé‡ï¼ˆDocker/ZeroTierï¼‰ä¹Ÿä¸€æ ·
sudo nft add chain inet vpn prerouting '{ type filter hook prerouting priority mangle; policy accept; }'
sudo nft add rule inet vpn prerouting ip daddr != @vpnset meta mark set 0xca6c counter
```
æ³¨æ„å‘½ä»¤é‡Œçš„`0xca6c`å„ä½æ›¿æ¢ä¸ºè‡ªå·±è·å–çš„å€¼å°±å¯ä»¥äº†<br><br>
ä¸è¿‡è¿™é‡Œæˆ‘ä»¬å¯¹**nft**çš„é…ç½®è¿˜æ²¡æœ‰å®Œæˆï¼Œç»è¿‡æˆ‘å®è·µå‘ç°ï¼Œå¦‚æœå°±è¿™æ ·åˆ°åé¢è¿DNSéƒ½ä¼šç›´æ¥åæ‰ï¼Œå› ä¸ºDNSè§£æçš„æµé‡ä¹Ÿä¼šè¢«æ‰“æ ‡ç­¾è¿‡VPNï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¾—æŠŠDNSè§£æçš„æµé‡åˆ†å‡ºæ¥ï¼Œè¿™éƒ¨åˆ†å¿…é¡»ç›´è¿ï¼Œè€Œä¸”åº”è¯¥åœ¨å…¨éƒ¨çš„æœ€å‰é¢ï¼Œå‘½ä»¤å¦‚ä¸‹[^nftcommand]
```bash
sudo nft add set inet vpn dns_upstream '{ type ipv4_addr; flags interval; }' # åˆ›å»ºå­setå­˜æ”¾
sudo nft add element inet vpn dns_upstream { 119.29.29.29, 223.5.5.5, 8.8.8.8, 1.1.1.1 } # è¿™äº›éƒ½æ˜¯DNSè§£æåœ°å€ï¼Œå¯ä»¥æ”¹æˆä½ è‡ªå·±çš„ï¼Œä¸è¿‡è¦å¯¹å¾—ä¸Šæœºå™¨ç”¨çš„DNSï¼Œä¸ç„¶ä¹Ÿä¸å¯¹ï¼Œå†™å“ªäº›åé¢smartdnså°±ä¹Ÿå†™å“ªäº›

# ç›´æ¥æ”¾è¡Œ
sudo nft insert rule inet vpn output ip daddr @dns_upstream counter accept
sudo nft insert rule inet vpn prerouting ip daddr @dns_upstream counter accept
```

éªŒè¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤åˆ—å‡ºç”µè„‘å…¨éƒ¨çš„nftableè§„åˆ™[^nftcommand]
```bash
sudo nft list ruleset
```
è¾“å‡ºé‡Œçœ‹åˆ°è¿™æ ·å°±æ˜¯æ­£å¸¸æ²¡é—®é¢˜çš„
```
table inet vpn {
        set vpnset {
                type ipv4_addr
                flags interval,timeout
                timeout 1h
        }

        set dns_upstream {
                type ipv4_addr
                flags interval
                elements = { 1.1.1.1, 8.8.8.8,
                             119.29.29.29, 223.5.5.5 }
        }

        chain output {
                type route hook output priority mangle; policy accept;
                ip daddr @dns_upstream counter packets 0 bytes 0 accept
                ip daddr != @vpnset meta mark set 0x0000ca6c counter packets 0 bytes 0
        }

        chain prerouting {
                type filter hook prerouting priority mangle; policy accept;
                ip daddr @dns_upstream counter packets 0 bytes 0 accept
                ip daddr != @vpnset meta mark set 0x0000ca6c counter packets 0 bytes 0
        }
}
```

### **smartdns**è‡ªåŠ¨å†™å…¥
ä¸è¿‡ç»„åˆ›å»ºå®Œäº†ï¼Œ**smartdns**è¿˜æ²¡æœ‰é…ç½®ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•åŸŸåå†™å…¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦é…ç½®**smartdns**ï¼Œè¿™æ ·å°±ä¼šè‡ªåŠ¨å†™å…¥IPåœ°å€äº†ã€‚é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œé¦–å…ˆè¿›å…¥é…ç½®æ–‡ä»¶æŒ‰ç…§å®˜ç½‘[^smartdns]æŒ‡ç¤ºæ·»åŠ è®¾ç½®
```bash
sudo vi /etc/smartdns/smartdns.conf
```
æ¯”å¦‚è¦`github.com`é€šè¿‡æ¢¯å­ï¼Œå°±åœ¨æœ€åé¢åŠ ä¸Š
```
nftset /github.com/#4:inet#vpn#vpnset
```
å…¶ä»–åŸŸåä¹ŸåŒç†æ›´æ”¹å‰é¢å°±å¯ä»¥äº†ã€‚<br><br>
ä¸è¿‡ä¸è¦ç€æ€¥ï¼Œä¸ºäº†åé¢[å–ä»£ç³»ç»ŸDNS](#smartdnså–ä»£ç³»ç»ŸDNS)ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œæ‰¾åˆ°æ–‡ä»¶å‰é¢ï¼ˆæˆ–è€…æ–°åŠ ï¼‰ï¼Œä¸è®ºå¦‚ä½•ä¿è¯æœ‰è¿™ä¸€è¡Œ
```
bind :53     # IPV4
bind [::]:53 # IPV6
```
è¿™ä¸ªçš„æ„æ€æ˜¯ç¨‹åºå¯åŠ¨åè‡ªåŠ¨æŒ‚è½½åˆ°ç”µè„‘çš„53ç«¯å£ï¼ˆä¹Ÿå°±æ˜¯DNSè§£æç«¯å£ï¼Œä¸è¿‡ç›®å‰è¿™ä¸ªç«¯å£è¿˜æœ‰ç³»ç»Ÿçš„DNSè§£æï¼Œæ‰€ä»¥å¯åŠ¨ä¹Ÿæ˜¯æ— ç”¨çš„ã€‚é…ç½®**smartdns**å¼€æœºå¯åŠ¨ä½¿ç”¨çš„å‘½ä»¤æ˜¯
```bash
sudo systemctl enable smartdns
```
ä¸è¿‡ç°åœ¨å¯åŠ¨**smartdns**æ— ç”¨ï¼Œå› ä¸ºæ­£å¦‚æˆ‘å‰é¢æ‰€è¯´ï¼Œ53ç«¯å£è¿˜å ç”¨ç€çš„ï¼Œåªæœ‰ç³»ç»ŸDNSä¸‹äº†å¯åŠ¨æ‰æ˜¯æˆåŠŸçš„<br><br>
æ€»çš„æ¥è¯´åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå¦‚æœåŸŸåç¬¦åˆæˆ‘ä»¬çš„è§„åˆ™ï¼Œå°±ä¼šè¢«æ‰“ä¸Šæ ‡è®°ï¼Œåé¢æˆ‘ä»¬åˆ©ç”¨è¿™äº›æ ‡è®°ï¼Œæ— æ ‡è®°çš„é€šè¿‡WireGuardå°±å¥½äº†
### **nftable**æŒä¹…åŒ–
ä¸è¿‡ç°åœ¨æˆ‘ä»¬å…ˆä¸“æ³¨äº**nft**ï¼Œæˆ‘ä»¬çš„å…¨éƒ¨é…ç½®éƒ½ä¾èµ–äºè¿™æ ·çš„è¡¨ï¼Œè€Œ**nftable**æœ‰ä¸€ä¸ªå¾ˆéº»çƒ¦çš„ç‚¹ï¼Œæ¯ä¸€æ¬¡é‡å¯ä½ çš„é…ç½®å°±æ²¡æœ‰äº†ï¼Œæˆ‘æ¯ä¸€æ¬¡é‡å¯åï¼Œå‰é¢é…ç½®çš„`vpn`è¡¨å°±æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å…¶é…ç½®æŒä¹…åŒ–ï¼Œæ¯ä¸€æ¬¡éƒ½èƒ½è‡ªåŠ¨è¯»å–ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹**nft**çš„é…ç½®ï¼Œå‘½ä»¤å¦‚ä¸‹[^nftcommand]
```bash
sudo sh -c "nft list table inet vpn > /etc/nftables.conf"
```
è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯æŠŠæŸ¥è¯¢çš„ç»“æœå†™å…¥`/etc/nftables.conf`{: .filepath} æ–‡ä»¶ï¼ˆè¦†ç›–å½“å‰å†…å®¹ï¼‰ï¼ŒæŸ¥è¯¢çš„å‘½ä»¤å°±æ˜¯æˆ‘ä»¬å‰é¢æµ‹è¯•æ·»åŠ æˆåŠŸæ²¡æœ‰çš„å‘½ä»¤ã€‚ç„¶åæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ä¸€ç‚¹ä¸œè¥¿ï¼Œå› ä¸ºè¿™ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤æ˜¯æœ‰ä¿¡æ¯çš„ï¼Œæ–‡ä»¶å¼€å¤´é€šå¸¸åº”è¯¥æœ‰`#!/usr/sbin/nft -f`å’Œ`flush ruleset`ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“å®ƒä»¬ä»€ä¹ˆæ„æ€ï¼Œä½†æ˜¯å°½é‡å°‘æ”¹ï¼Œæˆ‘è¿˜æ˜¯åˆè¿›å…¥æ–‡ä»¶æŠŠè¿™ä¸¤è¡Œè¡¥åœ¨äº†æ–‡ä»¶çš„å¼€å¤´ï¼Œç»“æœå°±æ˜¯è¿™æ ·çš„ï¼š
```
#!/usr/sbin/nft -f
flush ruleset

table inet vpn {
        set vpnset {
                type ipv4_addr
                flags interval,timeout
                timeout 1h
        }

        set dns_upstream {
                type ipv4_addr
                flags interval
                elements = { 1.1.1.1, 8.8.8.8, 119.29.29.29, 223.5.5.5 }
        }

        chain output {
                type route hook output priority mangle; policy accept;
                ip daddr @dns_upstream counter packets 0 bytes 0 accept
                ip daddr != @vpnset meta mark set 0x0000ca6c counter packets 0 bytes 0
        }

        chain prerouting {
                type filter hook prerouting priority mangle; policy accept;
                ip daddr @dns_upstream counter packets 0 bytes 0 accept
                ip daddr != @vpnset meta mark set 0x0000ca6c counter packets 0 bytes 0
        }
}
```

ç„¶åé…ç½®ä¸€ä¸‹å¼€æœºè‡ªåŠ¨è¯»å–è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥äº†ï¼Œåªéœ€è¦è¿™ä¸ªå‘½ä»¤
```bash
sudo systemctl enable --now nftables
```
å°±å¯ä»¥è‡ªåŠ¨è¯»å–äº†ã€‚
### **smartdns**å–ä»£ç³»ç»ŸDNS
ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æ­£é¢˜ï¼Œç”¨**smartdns**æ›¿æ¢ç³»ç»ŸDNSï¼Œé¦–å…ˆä½¿ç”¨è¿™ä¸ªå‘½ä»¤å…³é—­ç³»ç»ŸDNS
```bash
sudo systemctl disable --now systemd-resolved
```
ç„¶åå¯åŠ¨**smartdns**
```bash
sudo systemctl enable --now smartdns
```
è¿™æ—¶å»ºè®®å…ˆæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬å‰é¢çš„é…ç½®æœ‰æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥å…ˆæŸ¥è¯¢`table`ï¼Œç„¶å`ping`ä¸€ä¸ªç½‘ç«™ï¼Œç„¶åå†çœ‹`table`æœ‰æ²¡æœ‰å†™å…¥ã€‚ä¸ºæ­¤å¯ä»¥åƒæˆ‘ä¸€æ ·æŠŠä¸¤ä¸ªæµ‹å¤–éƒ¨IPçš„ç½‘ç«™é…ç½®æˆä¸€ä¸ªé€šè¿‡ï¼Œä¸€ä¸ªä¸é€šè¿‡ï¼ˆè¿™é‡Œè´´å‡ ä¸ªç½‘ç«™ï¼‰ï¼Œç„¶åæµ‹å¤–éƒ¨IPå°±å¾ˆå®¹æ˜“çœ‹åˆ°æœ‰æ²¡æœ‰é—®é¢˜
```bash
curl 4.ipw.cn
curl ipinfo.io
curl ipin.io
curl ipconfig.me
```

å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥è¯•ä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼Œä¸´æ—¶è§£å†³ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æºåœ°å€çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±æ˜¯ç½‘å¡çœ‹è¿”å›å’Œå‘é€ç½‘å¡ä¸ä¸€æ ·ç›´æ¥ä¸¢å¼ƒäº†
```bash
sudo iptables -t nat -A POSTROUTING -o <å‡ºå£çš„ç‰©ç†ç½‘å¡> -s <WireGuardåœ°å€> -j MASQUERADE
```
æ’¤é”€ç”¨è¿™ä¸ªå‘½ä»¤
```bash
sudo iptables -t nat -D POSTROUTING -o <å‡ºå£çš„ç‰©ç†ç½‘å¡> -s <WireGuardåœ°å€> -j MASQUERADE
```
ä¸¤ä¸ªå‘½ä»¤é‡Œçš„`<WireGuardåœ°å€>`å¯ä»¥è¿™æ ·å¾—åˆ°
```bash
ip -4 -o addr show dev privado.ams-034
```
å¾—åˆ°çš„æ˜¯
```
29: privado.ams-034    inet 100.65.38.223/32 scope global privado.ams-034\       valid_lft forever preferred_lft forever
```
å¦‚æœèƒ½è§£å†³é—®é¢˜ï¼ŒæŒä¹…åŒ–å°±å¾€`/etc/wireguard/<config_name>.conf`{: .filepath} çš„`[Interface]`é‡Œæ·»åŠ 
```
PostUp = iptables -t nat -A POSTROUTING -o enp4s0 -s <WG_IP>/32 -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o enp4s0 -s <WG_IP>/32 -j MASQUERADE
```

## Docker
åœ¨å‰é¢é…ç½®å®Œæˆä¹‹åï¼Œæˆ‘çš„ç”µè„‘å°±å·²ç»èƒ½ç”¨äº†ï¼Œæœ€åçš„å°é—®é¢˜æ˜¯Dockerçš„DNSåäº†ï¼ŒåŸå› æœªçŸ¥ï¼Œä½†æ˜¯è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å»Dockerçš„é…ç½®æ–‡ä»¶æ‰‹åŠ¨è®¾ç½®æœ¬æœºçš„DNSå°±å¯ä»¥äº†ï¼Œå°±æ˜¯å»`/etc/docker/daemon.json`{: .filepath} ä¿®æ”¹æ–‡ä»¶ï¼ŒåŠ ä¸Šè¿™æ®µ
```json
"dns":["192.168.101.92"]
```
å…¶ä¸­`192.168.101.92`æ˜¯ä¸»æœºçš„LAN IPï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹
```bash
ip -4 -o addr show dev <å‡ºå£ç‰©ç†ç½‘å¡ï¼Œæˆ‘æ˜¯enp4s0>
```
å¾—åˆ°
```
3: enp4s0    inet 192.168.101.92/24 brd 192.168.101.255 scope global dynamic noprefixroute enp4s0\       valid_lft 84212sec preferred_lft 84212sec
```
è¾“å‡ºç¬¬ä¸€ä¸ªå°±æ˜¯ä¸»æœºLAN IPï¼ŒåŠ ä¸Šé‡å¯Dockerå°±å¥½äº†
```bash
sudo systemctl restart docker
```

## é•¿æœŸä½¿ç”¨ç»´æŠ¤
ç°åœ¨æˆ‘ä»¬çš„é…ç½®å·²ç»å®Œæˆäº†ï¼Œæœ€åæˆ‘æ€»ç»“ä¸€ä¸‹é•¿æœŸä½¿ç”¨æ—¶çš„ç»´æŠ¤æ–¹æ³•ï¼Œå…¶å®ä¸»è¦æ˜¯æ·»åŠ åˆ é™¤åŸŸåä¹‹ç±»çš„<br><br>
é¦–å…ˆï¼Œæ›´æ”¹åŸŸåç›´æ¥ä¿®æ”¹`/etc/smartdns/smartdns.conf`{: .filepath} åœ¨åé¢æ·»åŠ åŸŸå
```
nftset /youtube.com/#4:inet#vpn#vpnset
```
ç„¶åé‡å¯**smartdns**å°±å¯ä»¥äº†
```bash
sudo systemctl restart smartdns
```


[^official]: Privadoå®˜æ–¹çš„é…ç½®æ•™ç¨‹ï¼š[Linux WireguardÂ® Manual Setup - PrivadoVPN](https://support.privadovpn.com/kb/article/1131-linux-wireguard%C2%AE-manual-setup/?section_id=108)
[^smartdns]: å®˜ç½‘IPSeté…ç½®æ–¹æ³•ï¼š[IPSetå’ŒNFTSet - SmartDNS](https://pymumu.github.io/smartdns/config/ipset-nftset/)
[^nftcommand]: [nftå¸¸ç”¨å‘½ä»¤åŠå…¶å‚æ•°è§£é‡Š - wanghongwei-dev - åšå®¢å›­](https://www.cnblogs.com/wanghongwei-dev/p/19046710)